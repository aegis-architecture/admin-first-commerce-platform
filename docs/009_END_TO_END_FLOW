# RBAC MODEL & END-TO-END FLOWS

**Architect Execution Framework â€” Phase 5**
**AEGIS Layer 2 â€” Architecture & Design Layer**
**Strict Role-Based Access Control & Runtime Execution Traces**

---

## Overview

Phase 5 defines the security and authorization model within each site (tenant). We implement a strict Role-Based Access Control (RBAC) system that ensures granular permission enforcement and clear boundary separation between different administrative roles.

---

## ðŸ” STRICT RBAC MODEL (Within Site)

Permissions are granular, not feature-bundled. No role implies global power.

### Entities

- **Role**: A named collection of permissions (e.g., \"Editor\", \"Finance\").
- **Permission**: A granular capability (e.g., `MANAGE_CONTENT`).
- **RolePermission**: Mapping between roles and permissions.
- **AdminSiteMembership**: Links an Admin Account to a specific Site with a specific Role.

### Granular Permissions Examples

- `MANAGE_CONTENT`: Create/Edit/Delete pages and blog posts.
- `MANAGE_PRODUCTS`: Create/Edit/Delete products and services.
- `MANAGE_ORDERS`: View and process orders.
- `MANAGE_INTEGRATIONS`: Configure payment gateways and email providers.
- `APPROVE_AI_SUGGESTIONS`: Explicit authority to apply AI-generated content.
- `VIEW_ANALYTICS`: Access to reporting and tracking data.
- `MANAGE_SITE_SETTINGS`: General site configuration (domain, theme, etc.).

### RBAC STRUCTURE â€” Mermaid ERD

```mermaid
erDiagram
    AdminAccount ||--o{ AdminSiteMembership : has
    Site ||--o{ AdminSiteMembership : scoped_to
    Role ||--o{ AdminSiteMembership : assigned

    Role ||--o{ RolePermission : contains
    Permission ||--o{ RolePermission : mapped_to
```

---

## ðŸ” RBAC ENFORCEMENT FLOW

Every admin request must pass through this validation chain. If any step fails, the system returns **403 Forbidden**.

1. **Auth Validation**: Verify JWT and session integrity.
2. **Site Resolution**: Determine which tenant is being accessed.
3. **Membership Lookup**: Verify admin belongs to that specific site.
4. **Role Lookup**: Identify the role assigned to the admin for that site.
5. **Permission Check**: Verify the role contains the required granular permission.
6. **Controller Execution**: Execute the requested domain logic.

---

## 1ï¸âƒ£ END-TO-END FLOW â€” VISITOR PURCHASE (Custom Domain)

**Scenario**: A visitor accesses `https://brand.com` and completes a purchase.

```mermaid
sequenceDiagram
    actor Visitor
    participant PublicWeb as Public Web Application
    participant API as Application API
    participant SiteResolver as Site Context Resolver
    participant CE as Commerce Engine
    participant IO as Integration Orchestrator
    participant PG as Payment Gateway
    participant DB as Primary Database

    Visitor->>PublicWeb: Load brand.com
    PublicWeb->>API: Request homepage (Host: brand.com)
    API->>SiteResolver: Resolve domain â†’ site_id
    SiteResolver-->>API: site_id = 123
    API->>DB: Fetch content for site_id 123
    DB-->>API: Content returned
    API-->>PublicWeb: Page rendered

    Visitor->>PublicWeb: Checkout Initiated
    PublicWeb->>API: POST /orders/checkout (site_id=123)
    API->>CE: Create Pending_Payment Order
    CE->>DB: Persist Order (site_id enforced)
    DB-->>CE: Order stored

    API->>IO: Create Payment Session
    IO->>PG: Request Payment
    PG-->>IO: Session Created

    PaymentGateway-->>IO: Webhook Authorized (Signature Validated)
    IO->>API: Validated Payment Event
    API->>CE: Confirm Payment
    CE->>DB: Transition to Confirmed (WHERE site_id=123)
    DB-->>CE: Confirmed
```

### Validation Points
âœ… **Tenant enforced**: All DB writes include `site_id`.
âœ… **Payment isolated**: Webhook validated before state change.
âœ… **AI not involved**: Commerce logic is deterministic.
âœ… **Lifecycle enforced**: State transitions follow the machine.

---

## 2ï¸âƒ£ END-TO-END FLOW â€” ADMIN CONTENT EDIT WITH AI (STRICT RBAC)

**Scenario**: Admin attempts to request and approve an AI suggestion.

```mermaid
sequenceDiagram
    actor Admin
    participant AdminWeb as Admin Web Application
    participant API as Application API
    participant Auth as Auth & Identity Resolver
    participant SiteResolver as Site Context Resolver
    participant RBAC as RBAC Enforcement
    participant AIService as AI Advisory Service
    participant DB as Primary Database

    Admin->>AdminWeb: Request AI Suggestion
    AdminWeb->>API: POST /suggestions

    API->>Auth: Validate Token
    API->>SiteResolver: Resolve site_id
    API->>RBAC: Check Permission: APPROVE_AI_SUGGESTIONS

    RBAC-->>API: Permission Granted

    API->>AIService: Generate Suggestion
    AIService->>DB: Store AISuggestion (site_id scoped)
    AIService-->>API: Suggestion Ready
    API-->>AdminWeb: Return Suggestion

    Admin->>AdminWeb: Approve Suggestion
    AdminWeb->>API: POST /suggestions/{id}/approve

    API->>RBAC: Verify MANAGE_CONTENT
    RBAC-->>API: Permission Granted
    API->>DB: Create New PageVersion (WHERE site_id=123)
    DB-->>API: Version Created
```

### Critical Constraints
ðŸ”’ **Dual Permissions Required**: `APPROVE_AI_SUGGESTIONS` AND `MANAGE_CONTENT`.
ðŸ”’ **AI cannot bypass RBAC**: API layer handles enforcement.
ðŸ”’ **Suggestion stored separately**: Never overwrites canonical data directly.
ðŸ”’ **Versioning enforced**: Content changes are auditable.

---

## 3ï¸âƒ£ RBAC FAILURE CASE

**Scenario**: Admin lacks required permission for an operation.

```mermaid
sequenceDiagram
    actor Admin
    participant API as Application API
    participant RBAC as RBAC Enforcement

    Admin->>API: POST /integrations/config (Update Stripe)
    API->>RBAC: Check Permission: MANAGE_INTEGRATIONS

    RBAC-->>API: Denied (Missing Permission)
    API-->>Admin: 403 Forbidden
```

### Containment
ðŸ”’ **No fallback**: System does not default to "allow".
ðŸ”’ **No soft override**: Configuration must be corrected in DB.
ðŸ”’ **No privilege escalation**: Admin cannot assign themselves permissions.

---

## 4ï¸âƒ£ MULTI-SITE ISOLATION TRACE

**Scenario**: A single admin belongs to two different sites with different roles.

```mermaid
sequenceDiagram
    actor Admin
    participant API as Application API
    participant SiteResolver as Site Context Resolver
    participant MS as Membership Service

    Admin->>API: Access siteA.dashboard.com
    API->>SiteResolver: Resolve site_id_A
    API->>MS: Verify membership(Admin, site_id_A)
    MS-->>API: Valid (Role: Editor)

    Admin->>API: Access siteB.dashboard.com
    API->>SiteResolver: Resolve site_id_B
    API->>MS: Verify membership(Admin, site_id_B)
    MS-->>API: Valid (Role: Accountant)
```

### Isolation Logic
ðŸ”’ **No cross-site data leakage**: Every query includes `WHERE site_id = resolved_site_context`.
ðŸ”’ **Context-switching**: Site context is resolved per-request based on domain/header.

---

## ðŸ” FINAL RBAC STATE MODEL

```mermaid
flowchart TD
    Request --> Auth
    Auth --> SiteResolution
    SiteResolution --> MembershipCheck
    MembershipCheck --> RoleLookup
    RoleLookup --> PermissionCheck

    PermissionCheck -->|Allowed| ControllerExecution
    PermissionCheck -->|Denied| AccessDenied
    
    ControllerExecution --> Success[Success 200/201]
    AccessDenied --> Forbidden[Forbidden 403]
```

---

## ARCHITECTURAL VALIDATION

âœ… **Strict RBAC per site**: Permissions scoped to tenant membership.
âœ… **Domain-based site resolution**: Custom domains and subdomains supported.
âœ… **Tenant-aware data enforcement**: `site_id` is a first-class citizen in the data layer.
âœ… **AI advisory gated**: AI suggestions cannot be applied without explicit permission.
âœ… **Deterministic commerce**: Order flows are immune to AI/Admin interference beyond rules.
âœ… **No authority leakage**: RBAC is enforced at the entry gate of the API.
âœ… **No cross-site coupling**: Databases are partitioned by `site_id`.

---

**RBAC Model Version**: 1.0
**Status**: Foundation Phase
**Last Updated**: February 16, 2026
**Next Phase**: Level 4 - Component Protocols (Detailed API Contracts)
